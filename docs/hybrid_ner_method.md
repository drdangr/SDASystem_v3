# Hybrid NER Method (spaCy + LLM)

## Цель
Точный и быстрый NER для новостей с минимизацией запросов к LLM и приоритетом канонических названий.

## Архитектура
- **spaCy**: быстрый первичный NER, эвристический confidence.
- **LLM (Gemini)**: рефайнмент низкоконфиденциальных и пропущенных сущностей; каноникализация/объединение алиасов.
- **HybridNERService**: оркестрирует spaCy + LLM, объединяет результаты.

## Алгоритм извлечения
1) spaCy извлекает сущности, вычисляет confidence (эвристики: тип, длина, капитализация, частота).  
2) Деление на high/low confidence (порог по умолчанию 0.75).  
3) LLM вызывается если:
   - spaCy не дал результатов, или
   - есть low-confidence сущности, или
   - явно включен `use_llm`.  
4) Объединение:
   - High-confidence spaCy → сразу в результат.
   - Low-confidence spaCy → замещаются/подтверждаются LLM.
   - LLM добавляет пропущенные (merge по нормализованному имени).

## Параметры
- `use_spacy`: включение spaCy.
- `use_llm`: включение LLM слоя.
- `use_llm_for_low_confidence`: перепроверка низкого confidence.
- `low_confidence_threshold`: порог confidence spaCy (реком. 0.75).
- `max_results`: 8–10 сущностей на текст (LLM подсказка).

## Confidence (spaCy, эвристика)
- Базовое значение по типу (person/org/company выше, misc ниже).
- Штраф/бонус за длину, капитализацию, повторяемость в тексте.
- Сужение confidence до [0.6; 0.95].

## Формат результата
```json
[
  {"name": "Elon Musk", "type": "person", "confidence": 0.90},
  {"name": "Tesla", "type": "company", "confidence": 0.90},
  {"name": "United States", "type": "country", "confidence": 0.90}
]
```

## Поведение при отсутствии акторов
- Если spaCy пуст и LLM выключен → пустой результат.
- Если spaCy пуст и LLM включен → LLM генерирует полный список.
- Если actors.json отсутствует: система инициирует авто-инициализацию (см. backend init flow).

## Производительность и стоимость
- spaCy покрывает 70–90% кейсов без LLM → экономия запросов.
- LLM вызывается точечно для сложных/низкоконф. случаев.

## Лучшие практики
- Использовать `use_llm_for_low_confidence=True` при критичных новостях.
- Держать `low_confidence_threshold` в диапазоне 0.7–0.8.
- Регулярно обновлять gazetteer (actors.json) для лучшей каноникализации.

