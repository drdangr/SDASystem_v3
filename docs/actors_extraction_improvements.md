# Улучшения извлечения акторов

## Выполненные улучшения

### 1. ✅ Улучшенный промпт для LLM
- Добавлены детальные инструкции по извлечению акторов
- Указание на необходимость извлекать косвенные упоминания (US → United States)
- Примеры использования
- Инструкции по использованию канонических названий

**Результат**: Precision выросла с 70% до 100%

### 2. ✅ Нормализация названий
- Автоматическое преобразование алиасов в канонические формы:
  - "US", "USA" → "United States"
  - "EU" → "European Union"
  - "NATO" → "NATO" (сохраняется)
- Поддержка кириллических названий

**Результат**: Лучшее сопоставление извлеченных и ожидаемых акторов

### 3. ✅ Улучшенная логика сравнения в тестах
- Улучшенное сопоставление через алиасы
- Частичное совпадение названий (например, "US" = "United States")
- Приоритет каноническим названиям

**Результат**: Recall вырос с 55.83% до 83.33%

### 4. ✅ Обработка пустых ответов
- Fallback на упрощенный промпт при пустых ответах
- Детерминированный режим для повторных попыток

## Текущие метрики

После улучшений:
- **Precision**: 100% (было 70%)
- **Recall**: 83.33% (было 55.83%)
- **F1-Score**: 89.33% (было 60.24%)

## Рекомендации по дальнейшим улучшениям

### 1. Повышение Recall до 90%+

**Проблема**: Некоторые акторы все еще пропускаются (особенно в новости про Climate Summit)

**Решения**:
- Добавить few-shot примеры в промпт (показать LLM примеры извлечения)
- Использовать более мощную модель (например, `gemini-2.0-flash-exp` или `gemini-1.5-pro`)
- Добавить пост-обработку: использовать NER библиотеку (spaCy) для дополнительного извлечения
- Увеличить `max_output_tokens` для извлечения большего количества акторов

### 2. Обработка квот API

**Проблема**: При частых запросах возникают ошибки 429 (quota exceeded)

**Решения**:
- Добавить retry логику с exponential backoff
- Использовать кэш более агрессивно
- Батчинг запросов (группировка новостей)
- Рассмотреть использование платного плана API

### 3. Улучшение определения типов акторов

**Проблема**: Иногда страны определяются как "organization"

**Решения**:
- Улучшить эвристики в `_looks_like_country()`
- Использовать знания из промпта более явно
- Добавить словарь известных стран/компаний для пост-обработки

### 4. Извлечение алиасов из текста

**Проблема**: LLM не всегда находит алиасы, которые есть в тексте

**Решения**:
- Явно просить LLM возвращать и канонические имена, и алиасы
- Использовать структуру ответа: `{"canonical": "...", "aliases": [...], "type": "..."}`
- Добавить отдельный проход для извлечения алиасов

### 5. Поддержка многоязычных текстов

**Текущая поддержка**: Базовая поддержка кириллицы

**Улучшения**:
- Более явная обработка транслитераций
- Использование нормализации Unicode
- Словарь переводов для популярных акторов

## Примеры улучшенного промпта (для будущих итераций)

### Few-shot промпт:
```python
prompt = """
Extract actors from text. Examples:

Text: "Putin criticized NATO and the US"
Output: [
  {"name": "Vladimir Putin", "type": "person", "confidence": 0.95},
  {"name": "NATO", "type": "organization", "confidence": 0.95},
  {"name": "United States", "type": "country", "confidence": 0.9}
]

Text: "Tesla announced plans in Texas, US"
Output: [
  {"name": "Tesla", "type": "company", "confidence": 0.95},
  {"name": "United States", "type": "country", "confidence": 0.9}
]

Now extract from:
Text: {text}
"""
```

### Структурированный ответ с алиасами:
```python
prompt = """
Extract actors. For each actor, return:
{
  "canonical_name": "full official name",
  "aliases_found": ["alias1", "alias2"],
  "type": "person|company|country|organization",
  "confidence": 0.0-1.0
}
"""
```

## Мониторинг качества

Для отслеживания качества в продакшене:

1. **Логирование метрик**:
   - Сохранять результаты каждого извлечения
   - Отслеживать precision/recall на реальных данных
   - Алерты при падении метрик ниже порога

2. **A/B тестирование**:
   - Тестировать разные версии промптов
   - Сравнивать разные модели
   - Измерять влияние изменений

3. **Ручная верификация**:
   - Выборочная проверка результатов редакторами
   - Создание "золотого стандарта" для тестирования
   - Регулярное обновление тестовых данных

## Использование

### Запуск тестов:
```bash
# Полный тест
pytest tests/test_actors_extraction.py::test_actors_extraction_for_all_news -v

# Детальный анализ одной новости
pytest tests/test_actors_extraction.py::test_single_news_detailed -v -s
```

### Обновление бэкапа:
```bash
python scripts/create_actors_backup.py
```

### Мониторинг метрик:
Метрики автоматически выводятся при запуске тестов. Для продакшена рекомендуется интегрировать логирование в систему мониторинга.

