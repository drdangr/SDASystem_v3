# Roadmap & Progress Checklist

Документ для отслеживания прогресса по этапам и задачам.  
Формат: отмечаем `[x]` для выполненного, `[ ]` для невыполненного.  
Агент при каждой итерации:

- Проверяет верхнеуровневые этапы и подзадачи.
- Обновляет чекбоксы по факту выполнения.
- Кратко фиксирует датой/комментарием, что сделано (в скобках).
- Не редактирует историю планов, только состояние чекбоксов и комментарии.

## Этап 1. Полное покрытие концепции на мок-данных (выполнено 2025-12-06)

- [x] Задача 1.1 Таймлайн и события (2025-12-06: генерация в `load_data`, UI состояния/цвета/зум)
  - [x] Подзадача 1.1.1 Генерация событий при загрузке мок-данных (`load_data` + `EventExtractionService`)
  - [x] Подзадача 1.1.2 Фолбэк дат на `published_at`, поддержка RU/EN паттернов
  - [x] Подзадача 1.1.3 UI: состояния загрузка/пусто/ошибка, цвета fact/opinion, зум-кнопки
- [ ] Задача 1.1.A Доработка таймлайна (замечание)
  - [ ] Подзадача 1.1.A.1 Редизайн таймлайна (выравнивание тиков/пинов, компактный вид как в референсе)
  - [ ] Подзадача 1.1.A.2 Отделить сглаженные/жёсткие зумы, корректное позиционирование меток
  - [ ] Подзадача 1.1.A.3 Привести цвета/размеры в соответствии с минималистичным гайдлайном
- [x] Задача 1.2 Сюжеты: список/граф (2025-12-06: метрики+домены в UI, панели/resizer стабильны)
  - [x] Подзадача 1.2.1 Метрики relevance/cohesion/size/freshness в UI
  - [x] Подзадача 1.2.2 Домены/поддомены в списке и карточке
  - [x] Подзадача 1.2.3 Панели/resizer, сохранение состояний в localStorage (проверено)
- [x] Задача 1.3 Детали сюжета (2025-12-06: буллеты, акторы, новости, события)
  - [x] Подзадача 1.3.1 Буллеты, топ-акторы, связанные новости
  - [x] Подзадача 1.3.2 Отображение событий сюжета (таймлайн)
- [x] Задача 1.4 Детали новости/актора (2025-12-06: акторы/related/mentions/relations)
  - [x] Подзадача 1.4.1 Новости: акторы, related (минимум базовые данные)
  - [x] Подзадача 1.4.2 Акторы: mentions, relations
- [x] Задача 1.5 Механики мок-LLM (2025-12-06: стабильные заглушки summary/bullets/actors/events/domains)
  - [x] Подзадача 1.5.1 Заглушки summary/bullets/actors/events/domains для стабильного UI
- [x] Задача 1.6 Тесты (мок-уровень) (2025-12-06: юнит + API, pytest green)
  - [x] Подзадача 1.6.1 Юнит: GraphManager, EventExtractionService, EmbeddingService, NERService, ClusteringService (базовый кейс)
  - [x] Подзадача 1.6.2 Интеграция API: stories/news/actors/events/graph
  - [x] Подзадача 1.6.3 pytest прогон успешен
- [ ] Задача 1.A Общий редизайн/уплотнение UI (замечание)
  - [ ] Подзадача 1.A.1 Уменьшить размеры заголовков, кнопок, отступов (минималистичный вид)
  - [ ] Подзадача 1.A.2 Пересмотреть веса/цвета вспомогательных элементов, освободить место под данные в панелях
  - [ ] Подзадача 1.A.3 Проверить адаптивность и сохранение состояний после редизайна

## Этап 2. Подмена заглушек реальной работой LLM, постепенный отказ от мок-данных кроме новостей

- [x] Задача 2.0 Архитектура AI-сервисов/конфигурации (2025-12-06: реестр, профили, UI)
  - [x] Подзадача 2.0.1 Конфиг сервисов и LLM-профилей в JSON (+ пример) (2025-12-06)
  - [x] Подзадача 2.0.2 ServiceRegistry + регистрация модулей (начать с Summary+NER) (2025-12-06)
  - [x] Подзадача 2.0.3 Хот-релоад конфигов без рестарта (перечтение/кэш) (2025-12-06)
  - [x] Подзадача 2.0.4 API: GET/PUT `/api/llm/services` + привязка профилей, dev invoke (2025-12-06)
  - [x] Подзадача 2.0.5 UI модалка: автоген по сервисам/профилям, автоподстановка параметров, PUT профиля (2025-12-06)
- [x] Задача 2.1 Подготовка LLM-интеграции (2025-12-06: Gemini ключ/env, кэш, сервис обновлён)
  - [x] Подзадача 2.1.1 Определить провайдера/модель, лимиты, ключи, env-переменные (Gemini 2.5, `.env` с ключом)
  - [x] Подзадача 2.1.2 Добавить конфиги/секреты (без хардкода), кэширование результатов (`config/gemini.env.example`, file cache)
  - [x] Подзадача 2.1.3 Обновить `LLMService` (реальные вызовы + мок-режим) (Gemini SDK + fallback)
  - [x] Подзадача 2.1.4 Тесты: контрактные с моками ответов (стаб клиент) (`tests/test_llm_api.py`)
- [x] Задача 2.2 Подключение генерации summary/bullets
  - [x] Подзадача 2.2.1 Бэкенд: маршруты/сервисы вызывают LLM, кэшируют (`/api/llm/generate`, file cache)
  - [x] Подзадача 2.2.2 Фронт: отображение загрузки/ошибки/ретрай (автозапуск summary/bullets без кнопок, статус Loading/Cached/Done/Error, локальный кэш)
  - [x] Подзадача 2.2.3 Тесты: unit + интеграция API (`tests/test_llm_api.py`)
  - [x] Подзадача 2.2.4 Пользовательская проверка: показать историю с новыми summary/bullets, подтвердить (подтверждено пользователем)
  - [ ] Подзадача 2.2.5 Интеграция в news-only pipeline: при пересборке/обновлении stories из news — пересчитать и сохранить `story.summary` (2025-12-15)
  - [ ] Подзадача 2.2.6 Интеграция в news-only pipeline: при пересборке/обновлении stories из news — пересчитать и сохранить `story.bullets` (2025-12-15)
- [x] Задача 2.3 Подключение NER/actors через LLM (или модель)
  - [x] Подзадача 2.3.1 Обогащение новостей акторами, обновление графа (Hybrid NER: spaCy + LLM fallback)
  - [x] Подзадача 2.3.2 Тесты: unit на NER pipeline, интеграция API actors/mentions
  - [x] Подзадача 2.3.3 Пользовательская проверка: карточка актора/mentions, подтвердить (верифицировано на русских новостях)
  - [x] Подзадача 2.3.4 **NEW** Мультиязычность: определение кириллицы, динамическая загрузка spaCy моделей (ru/en)
  - [x] Подзадача 2.3.5 **NEW** Канонизация: интеграция с Wikidata, лемматизация русских имен
  - [x] Подзадача 2.3.6 **NEW** Продвинутая дедупликация: слияние по QID, рефакторинг `ActorDeduplicator`
  - [x] Подзадача 2.3.7 Пересчет `story.top_actors` при обновлении акторов/новостей (2025-12-15: реализовано в `update_story_top_actors`, вызывается при `extract_for_news` и обновлении акторов)
- [ ] Задача 2.4 Timeline на базе EventExtraction (facts/opinions): извлечение событий из news и сборка таймлайна story (2025-12-15: уточнение цели)
  - [x] Подзадача 2.4.1 Извлечение событий из каждой новости (EventExtraction) + привязка к `story_id` (2025-12-15: реализовано в `load_data`, извлекаются при загрузке)
  - [x] Подзадача 2.4.2 Привязка событий к `story.event_ids` и сохранение/обновление артефакта (2025-12-15: реализовано в `add_event`, события привязываются к story)
  - [ ] Подзадача 2.4.3 LLM-улучшение (опционально): подсказки/парсинг, фолбэк на детерминированную логику
  - [ ] Подзадача 2.4.4 Тесты: unit + интеграция `/api/stories/{id}/events`
  - [ ] Подзадача 2.4.5 Пользовательская проверка: таймлайн с event_type fact/opinion, подтвердить
  - [ ] Подзадача 2.4.6 Разделение фактов и мнений: стабильно классифицировать события (fact vs opinion) (2025-12-15: добавить в роадмап)
    - [ ] Подзадача 2.4.6.1 Критерий качества: ручной чек-лист/тесты на fact/opinion разметку
- [ ] Задача 2.5 Подключение доменов/категорий через LLM
  - [ ] Подзадача 2.5.1 Обогащение news/story доменами, отображение в UI
  - [ ] Подзадача 2.5.2 Тесты: unit + интеграция API
  - [ ] Подзадача 2.5.3 Пользовательская проверка: домены в списке/карточке, подтвердить
- [ ] Задача 2.6 Переход с мок-эмбеддингов на реальные вычисления: замена фейкового сервиса на реально работающий (2025-12-15: используется мок, не реальные embeddings)
  - [ ] Подзадача 2.6.1 Реализация локального подхода: интеграция sentence-transformers (all-MiniLM-L6-v2 или аналогичная модель)
  - [ ] Подзадача 2.6.2 Реализация облачного подхода: использование Gemini API для генерации embeddings (если доступно)
  - [ ] Подзадача 2.6.3 Сравнение подходов: бенчмарк скорости и стоимости (локальный vs Gemini) на тестовом наборе новостей
  - [ ] Подзадача 2.6.4 Выбор оптимального решения: на основе результатов сравнения определить предпочтительный подход
  - [ ] Подзадача 2.6.5 Интеграция выбранного решения: замена мок-сервиса, обновление `EmbeddingService`, добавление env-переменных для переключения
  - [ ] Подзадача 2.6.6 Миграция существующих данных: пересчет embeddings для всех новостей без embedding (опционально, батчами)
  - [x] Подзадача 2.6.7 Использовать embeddings для `compute_news_similarities` (и при необходимости кэшировать результаты) (2025-12-15: реализовано, но работает на моках)
- [x] Задача 2.6.B Миграция хранения данных: переход с JSON на PostgreSQL + pgvector (2025-12-15: выполнено — все вычислимые данные теперь в БД)
  - [x] Подзадача 2.6.B.1 Проектирование схемы БД: определить структуру таблиц для всех сущностей (news, actors, stories, events, domains, relations) (2025-12-15: схема создана в docs/database_schema.md)
  - [x] Подзадача 2.6.B.2 Установка и настройка PostgreSQL + pgvector: расширение для векторного поиска (2025-12-15: зависимости добавлены в requirements.txt, инструкции в docs/database_setup.md)
  - [x] Подзадача 2.6.B.3 Создание схемы БД: таблицы для news (с embedding vector), actors, actor_relations, stories, events, domains, news_relations, связующие таблицы (news_actors, story_news, story_actors, event_actors) (2025-12-15: схема создана в backend/db/schema.sql)
  - [x] Подзадача 2.6.B.4 Создание индексов: векторный индекс для news.embedding (ivfflat/hnsw), индексы для FK и частых запросов (2025-12-15: индексы включены в schema.sql)
  - [x] Подзадача 2.6.B.5 Реализация слоя доступа к БД: абстракция над SQL (SQLAlchemy или raw psycopg2), замена in-memory словарей в GraphManager (2025-12-15: DatabaseManager создан, GraphManager рефакторен)
  - [x] Подзадача 2.6.B.6 Интеграция векторного поиска: замена `compute_news_similarities` на pgvector similarity search (cosine distance) (2025-12-15: реализовано в DatabaseManager.compute_news_similarities)
  - [x] Подзадача 2.6.B.7 Миграция существующих данных: скрипт переноса всех данных из JSON (news, actors, stories, events, domains, relations) в PostgreSQL (2025-12-15: скрипт scripts/migrate_json_to_db.py создан)
  - [x] Подзадача 2.6.B.8 Обновление GraphManager: адаптация всех операций (add_news, add_actor, add_story, add_event, compute_similarities) под БД вместо in-memory (2025-12-15: GraphManager полностью рефакторен)
  - [x] Подзадача 2.6.B.9 Обновление сервисов: ActorsExtractionService, ClusteringService, EventExtractionService — работа с БД вместо JSON (2025-12-15: ActorsExtractionService обновлен, остальные используют GraphManager)
  - [x] Подзадача 2.6.B.10 Обновление API endpoints: адаптация всех маршрутов для работы с БД (2025-12-15: load_data обновлен, endpoints работают через GraphManager)
  - [x] Подзадача 2.6.B.11 Тестирование: проверка производительности, корректности миграции, целостности данных (2025-12-15: тесты test_database_manager.py созданы; 2026-01-02: полный набор из 36 тестов реализован и пройден, покрытие всех CRUD операций, связей, векторного поиска, транзакций, интеграционных сценариев, граничных случаев и производительности)
- [ ] Задача 2.7 Clustering: собирать новости в истории автоматически (2025-12-15: не интегрировано в основной пайплайн)
  - [ ] Подзадача 2.7.1 Кластеризация `news` → `stories` при отсутствии `stories.json` (DBSCAN/graph components) (2025-12-15: реализовано в `ClusteringService`, но НЕ вызывается в `load_data`, только в `/api/initialize`)
  - [ ] Подзадача 2.7.2 Сохранение/обновление `data/stories.json` как артефакта пайплайна (2025-12-15: не реализовано автоматическое сохранение)
  - [ ] Подзадача 2.7.3 Stories как динамический артефакт: при изменениях в news/actors и их связях перевычислять/обновлять истории (добавление новостей, ручное редактирование акторов/новостей, пересчет similarity/связей)
  - [ ] Подзадача 2.7.4 При пересборке/ручном редактировании истории — пересчитать принадлежность доменам (story.domains/primary_domain), если включен модуль доменов (см. 2.5)
- [ ] Задача 2.8 UI/UX отказоустойчивость
  - [ ] Подзадача 2.8.1 Спиннеры/ретраи/деградация на ошибках LLM
  - [ ] Подзадача 2.8.2 Тесты: e2e/ручной чек-лист
  - [ ] Подзадача 2.8.3 Пользовательская проверка: сценарий с искусственной ошибкой, подтвердить
  
### Критерий прохождения Этапа 2: news-only pipeline (в работе)

Цель: система должна полностью отрабатывать, имея на входе только новости (`data/news.json`), а остальные файлы в `data/` становятся перевычисляемыми артефактами пайплайна.  

## Этап 3. Модуль сбора и нормализации новостей

- [ ] Задача 3.1 Проектирование ingestion
  - [ ] Подзадача 3.1.1 Форматы сырого/нормализованного (docs + схемы)
  - [ ] Подзадача 3.1.2 Очередь/батчинг, ретраи, логирование
  - [ ] Подзадача 3.1.3 Пользовательская проверка: согласовать схемы
- [ ] Задача 3.2 Коннектор RSS (минимум один)
  - [ ] Подзадача 3.2.1 Реализация fetch + парсинг + ретраи
  - [ ] Подзадача 3.2.2 Тесты: юнит парсеров, интеграция коннектора (моки)
  - [ ] Подзадача 3.2.3 Пользовательская проверка: прогон на тестовом feed, подтвердить
- [ ] Задача 3.3 Нормализация + дедуп + обогащение
  - [ ] Подзадача 3.3.1 normalize_raw_item → News, дедуп по url/title/хэшу
  - [ ] Подзадача 3.3.2 Обогащение embeddings/NER/events (используя текущее LLM/моки)
  - [ ] Подзадача 3.3.3 Тесты: unit на дедуп/нормализацию, интеграция с graph_manager
  - [ ] Подзадача 3.3.4 Пользовательская проверка: выборочный просмотр нормализованных записей
- [ ] Задача 3.4 E2E ingest → normalize → graph update
  - [ ] Подзадача 3.4.1 Сбор тестового батча, загрузка в граф, ререндер UI
  - [ ] Подзадача 3.4.2 Тесты: e2e сценарий (скрипт/pytest)
  - [ ] Подзадача 3.4.3 Пользовательская приемка: показать обновленный UI, подтвердить

## Инструкции по обновлению

- При выполнении задачи меняйте `[ ]` → `[x]` и добавляйте краткий комментарий `(дата: что сделано)`.
- Не удаляйте и не перефразируйте существующие пункты без согласования.
- Если добавляются новые подзадачи, формулируйте их кратко и измеримо.
