# Изменения: Автоматическое определение языка

## Что изменилось

### 1. Автоматическое определение языка текста
- Система автоматически определяет язык текста (русский/английский) по наличию кириллицы
- Автоматически выбирает соответствующую модель spaCy:
  - **Русский текст** → `ru_core_news_md` (или `ru_core_news_lg`)
  - **Английский текст** → `en_core_web_sm` (или `en_core_web_lg`)

### 2. Кэширование моделей
- Загруженные модели кэшируются для быстрого переключения
- Не нужно перезагружать модели при смене языка

### 3. Fallback механизм
- Если нужная модель недоступна, система пробует альтернативные модели того же языка

## Измененные файлы

1. **`backend/services/ner_spacy_service.py`**:
   - Добавлена функция `detect_language()` - определяет язык по кириллице
   - Добавлена функция `get_model_for_language()` - выбирает модель для языка
   - Добавлена функция `check_model_available()` - проверяет доступность модели
   - Модифицирован `HybridNERService`:
     - Добавлен параметр `auto_detect_language` (по умолчанию `True`)
     - Добавлен параметр `prefer_large_models` (по умолчанию `False`)
     - Добавлен кэш моделей `_model_cache`
     - Добавлен метод `_get_model_for_text()` - автоматически выбирает модель
     - Метод `extract_actors()` теперь использует автоматический выбор модели

2. **`backend/services/actors_extraction_service.py`**:
   - Обновлен вызов `create_hybrid_ner_service()` для использования автоопределения

3. **`backend/api/routes.py`**:
   - Обновлена инициализация `ActorsExtractionService`:
     - Если `SPACY_MODEL` не установлен или равен `"en_core_web_sm"` → используется автоопределение
     - Иначе используется указанная модель

## Новые файлы

1. **`scripts/install_spacy_models.py`**:
   - Скрипт для проверки и установки недостающих моделей spaCy

2. **`AUTO_LANGUAGE_DETECTION.md`**:
   - Документация по автоматическому определению языка

## Как использовать

### По умолчанию (автоматически)
Система автоматически определяет язык и выбирает модель. Ничего делать не нужно!

### Установка недостающих моделей
```bash
python3 scripts/install_spacy_models.py
```

### Отключение автоопределения (если нужно)
Установите переменную окружения:
```bash
export SPACY_MODEL=ru_core_news_lg
```

## Обратная совместимость

✅ Старый код продолжает работать:
- Если указана конкретная модель → используется она
- Если модель не указана → используется автоопределение
- Можно отключить автоопределение через параметры

## Преимущества

1. ✅ **Автоматическая обработка смешанных языков** - не нужно указывать язык вручную
2. ✅ **Оптимальная модель для каждого языка** - лучшая точность для русского и английского
3. ✅ **Работает "из коробки"** - без дополнительной настройки
4. ✅ **Кэширование** - быстрая работа при переключении языков

## Примеры работы

### До изменений
```python
# Нужно было вручную указывать модель
service = create_hybrid_ner_service(llm, spacy_model="ru_core_news_md")
# Для английского текста нужно было менять модель
```

### После изменений
```python
# Автоматически определяет язык и выбирает модель
service = create_hybrid_ner_service(llm, auto_detect_language=True)
# Работает с русским и английским текстом автоматически
```

## Тестирование

Для проверки работы:

1. **Проверить определение языка**:
   ```bash
   python3 -c "from backend.services.ner_spacy_service import detect_language; print(detect_language('Владимир Путин'))"
   # Должно вывести: ru
   ```

2. **Проверить выбор модели**:
   ```bash
   python3 -c "from backend.services.ner_spacy_service import get_model_for_language; print(get_model_for_language('ru'))"
   # Должно вывести: ru_core_news_md
   ```

3. **Установить недостающие модели**:
   ```bash
   python3 scripts/install_spacy_models.py
   ```

## Что дальше

После этих изменений:
1. ✅ Система автоматически обрабатывает русскоязычные новости
2. ✅ Не нужно вручную переключать модели
3. ✅ Оптимальная точность для каждого языка

Для вашей русскоязычной новости система автоматически:
- Определит, что текст на русском
- Выберет `ru_core_news_md` для обработки
- Извлечет акторов с высокой точностью

